<html>

<head>
	<script>
		var game_path = location.href.lastIndexOf("/") !== -1 ? location.href.substring(0, location.href.lastIndexOf("/") + 1) : location.href;
	</script>
	<script type="text/javascript" src="https://rawgithub.com/craftyjs/Crafty/release/dist/crafty-min.js"></script>
	<script type="text/javascript" src="./sprites.js"></script>
	<script type="text/javascript" src="./efects.js"></script>
	<script type="text/javascript" src="./players.js"></script>
	<script type="text/javascript" src="./weapons.js"></script>
	<script type="text/javascript" src="./socket.io.js"></script>
</head>

<body style="font-family:tahoma;">
	<style>
		#createbutton {
			width: 150px;
			height: 15px;
			background-color: #efefef;
			text-align: center;
			padding: 10px;
			cursor: pointer;
			margin-bottom: 5px;
			margin-top: 5px;
		}
	</style>

	<input type="text" placeholder="nick" id="nick" value="Keke">
	<input type="text" placeholder="renk" id="renk" value="red">

	<div onclick="createControllablePlayer()" id="createbutton">Oyuncu Olu≈ütur</div>

	<div id="game" style="border:1px dotted #000;"></div>

	<script>
		//var socket = io('http://127.0.0.1:3000');
		var socket = io('http://192.168.6.80:3000');
		
		
		
		

		var myplayer = null;

		var boardWidth = 1024;
		var boardHeight = 768;
		
		socket.on("sendCorrections",function(){
			if(myplayer !== null){
				socket.emit("correction",{ 
					x: myplayer.x, 
					y: myplayer.y, 
					rotation: myplayer.rotation, 
					playerId: myplayer._playerId,
					movement:myplayer.engine.move, 
					rotate:myplayer.engine.rotate,
					shoot:myplayer.engine.isShooting					
				});
			}		
		});
		
		socket.on("newPlayerJoined", function (newPlayerInfo) {
			console.log("new-player-joined", newPlayerInfo);			
			createOtherPlayer(newPlayerInfo.playerid, newPlayerInfo.nick, newPlayerInfo.color,true);			
		});
		

		Crafty.init(boardWidth, boardHeight, document.getElementById('game'));

		function createControllablePlayer() {
			if(myplayer !== null){
				return false;
			}
			var playerColor = document.getElementById("renk").value;
			var playerNick = document.getElementById("nick").value;

			createMyPlayer(playerNick, playerColor);
		}

		function createMyPlayer(nick, color) {
			if (myplayer) return;

			myplayer = Crafty.e("MyPlayer")
				.color(color)
				.setName(nick)
				.showName()
				.addWeapon('rifle')
				.bindSocket(socket)
				.reset();

			socket.emit("createPlayerOnServer", {
				playerid: myplayer._playerId,
				nick: nick,
				color: color,
			});

			return myplayer;
		}

		function createOtherPlayer(id, nick, color,isPristine) {

			var player = Crafty.e("OtherPlayer")
				.setId(id)
				.color(color)
				.setName(nick)
				.showName()
				.addWeapon('rifle')
				.bindSocket(socket)
				
				if(!isPristine){
					player.flicker = false;
				}
				else{
					player.reset();
				}

			return player;
		}
		socket.on("currentPlayerList",function(playerList){
				playerList.forEach(function(player){				  
					createOtherPlayer(player.playerid,player.nick,player.color,false);
				});
				socket.emit("ineedcorrections");
		});
		socket.emit("getPlayers");
		
	</script>

</body>

</html>